# Requirements for `x86-alignment-check`

## 1. Core Functionality

- The library MUST provide a mechanism to enable and disable the alignment check (AC) flag in the `eflags`/`rflags` register on `x86` and `x86_64` architectures.

## 2. Environment

- The library MUST be `#![no_std]` compatible, meaning it cannot depend on the standard library.

## 3. Supported Architectures

- The library MUST support both `x86` and `x86_64` target architectures.

## 4. API

### 4.1. `x86_alignment_check`

- A function `x86_alignment_check(b: bool) -> bool` MUST be provided.
- This function will set the AC flag to the value of `b`.
- It MUST return the previous state of the AC flag (true if it was set, false otherwise).

### 4.2. `ac_call_once`

- A function `ac_call_once<F, T>(f: F) -> T where F: FnOnce() -> T` MUST be provided.
- This function will execute the closure `f` with the AC flag enabled.
- It MUST restore the original state of the AC flag after the closure has been executed.
- It MUST return the value returned by the closure `f`.

### 4.3. `no_ac_call_once`

- A function `no_ac_call_once<F, T>(f: F) -> T where F: FnOnce() -> T` MUST be provided.
- This function will execute the closure `f` with the AC flag disabled.
- It MUST restore the original state of the AC flag after the closure has been executed.
- It MUST return the value returned by the closure `f`.

## 5. Testing

- The library MUST include unit tests to verify the correct functionality of all public API functions.
- Tests should cover:
    - Setting and unsetting the AC flag.
    - Verifying the return value (previous flag state).
    - The correct execution of closures within `ac_call_once` and `no_ac_call_once`.
    - Nested calls to demonstrate robustness.
- A test that is expected to fail with a SIGBUS error when alignment checking is on SHOULD be included but marked as `#[ignore]` to prevent CI failure.
